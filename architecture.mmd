graph TB
  %% Clients
  U[Mobile/Web/Partner Channels]:::edge

  %% Primary DC (Active)
  subgraph DC_A[Primary DC — Active]
    GW[API Gateway / WAF<br/>TLS, mTLS, OAuth2, HMAC, Rate-limit,<br/>Idempotency-Key enforcement, PII scrubbing]:::core
    PAY["Payments Service<br/>(Orchestration/Saga, Validation,<br/>PSP Routing, Outbox)"]:::core
    ADP["PSP/Bank Adapters<br/>(CB/Retry/Timeout/Bulkhead,<br/>Signature/HMAC)"]:::core
    WH["Webhook Ingest<br/>(Store-then-Process, Retry, DLQ)"]:::core
    LED["Ledger Service<br/>(Double-entry)"]:::state
    RCN["Reconciliation<br/>(T+0 stream, T+1 files)"]:::state
    FRD["Fraud & Risk Controls<br/>(Velocity, device hooks)"]:::edge
    FLG["Feature Flags / Kill-switches<br/>(Audit trail)"]:::ctrl
    EV[("Kafka / Redpanda<br/>Event Bus")]:::data
    DB[("PostgreSQL 16 OR CockroachDB<br/>Payments + Ledger")]:::data
    RDS[("Redis<br/>Idempotency/Rate-limit/Locks")]:::data
    OBJ[("MinIO / S3-compatible<br/>Webhook payloads, T+1 files")]:::data
    KMS["Secrets / KMS<br/>(Vault/HSM)"]:::ctrl
    IDP["IdP (OIDC / Keycloak)"]:::ctrl

    %% Observability stack
    OTL["OpenTelemetry Collectors"]:::obs
    PM[("Prometheus")]:::obs
    LK[("Loki")]:::obs
    TP[("Tempo")]:::obs
    GF["Grafana"]:::obs
  end

  %% Secondary DC (Passive / DR)
  subgraph DC_B[Secondary DC — Passive/DR]
    EV_B[("Kafka Mirror / Cluster")]:::data
    DB_B[("Replica DB")]:::data
    OBJ_B[("Object Store Replica")]:::data
    OTL_B["OTEL Collectors"]:::obs
    PM_B[("Prometheus")]:::obs
    LK_B[("Loki")]:::obs
    TP_B[("Tempo")]:::obs
    GF_B["Grafana"]:::obs
  end

  %% External PSP/Bank zone
  PSP[("External PSPs / Banks")]:::ext

  %% Flows
  U -->|HTTPS| GW
  GW --> PAY
  PAY --> ADP
  ADP -->|API calls| PSP
  PSP -->|"Webhooks (mTLS/HMAC + allowlist)"| GW
  GW --> WH

  %% Event-driven core
  PAY -->|"Outbox→Produce"| EV
  WH -->|Events| EV
  EV --> LED
  EV --> RCN
  EV --> FRD
  EV --> PAY

  %% State & storage
  PAY --> DB
  LED --> DB
  RCN --> OBJ
  PAY --> RDS
  WH --> OBJ

  %% Control plane
  PAY -. "config/API" .-> FLG
  ADP -. "config/API" .-> FLG
  GW --> IDP
  PAY --> KMS
  ADP --> KMS
  WH --> KMS

  %% Observability wiring
  GW --> OTL
  PAY --> OTL
  ADP --> OTL
  LED --> OTL
  WH --> OTL
  RCN --> OTL
  OTL --> PM
  OTL --> LK
  OTL --> TP
  PM --> GF
  LK --> GF
  TP --> GF

  %% DR replication
  EV -->|Mirror| EV_B
  DB -->|"Async replication (RPO ≤ 5m)"| DB_B
  OBJ -->|Bucket replication| OBJ_B
  PM --> PM_B
  LK --> LK_B
  TP --> TP_B

  classDef core fill:#f3f7ff,stroke:#4472c4,stroke-width:1px;
  classDef state fill:#eefcf4,stroke:#2e8540,stroke-width:1px;
  classDef data fill:#fff7e6,stroke:#b36b00,stroke-width:1px;
  classDef obs fill:#f6e6ff,stroke:#7a3db8,stroke-width:1px;
  classDef ctrl fill:#e8f0fe,stroke:#185abc,stroke-width:1px;
  classDef edge fill:#e9ecef,stroke:#6c757d,stroke-width:1px;
  classDef ext fill:#ffe6ea,stroke:#d6336c,stroke-width:1px;