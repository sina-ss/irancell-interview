sequenceDiagram
  autonumber
  participant C as Client (App/Web)
  participant GW as API Gateway/WAF
  participant P as Payments Service
  participant A as PSP Adapter (Primary)
  participant B as PSP Adapter (Backup)
  participant PSP as PSP/Bank
  participant EB as Event Bus (Kafka)
  participant L as Ledger Service
  participant WH as Webhook Ingest

  C->>GW: POST /payments (Idempotency-Key)
  GW->>P: Forward (authn, rate-limit, key enforced)
  P->>P: Validate & persist (txn row + outbox)
  P->>A: authorize()
  A->>PSP: HTTPS /authorize
  PSP-->>A: 200 Approved (auth_id)
  A-->>P: Auth result
  P->>EB: Publish AUTH_APPROVED
  EB->>L: Write ledger (auth hold)
  P-->>GW: 201 Accepted (txn_id)

  Note over PSP,WH: Settlement arrives later via webhook
  PSP-->>WH: Webhook (capture/settlement)
  WH->>EB: Publish SETTLED
  EB->>L: Ledger capture

  alt PSP timeout/5xx
    A--x P: error
    P->>A: Retry with backoff + jitter (max 2)
    A--x P: still failing
    P->>P: Open circuit breaker for PSP_A
    P->>B: Failover authorize() to PSP_B (if enabled by feature flag)
  else Declined (business)
    A-->>P: Decline
    P->>EB: Publish DECLINED (not a technical error)
  end
