%% /happy-path.mmd - High-Level Payment Flow
sequenceDiagram
  autonumber
  participant C as Client
  participant RL as Rate Limiter
  participant LB as Load Balancer
  participant GW as API Gateway
  participant FR as Fraud Detection
  participant P as Payments Service
  participant PSP as PSP Gateway
  participant K as Kafka
  participant L as Ledger Service
  participant DBW as PostgreSQL Master (Write)
  participant DBR as PostgreSQL Read
  participant R as Redis Cache

  %% Initial Request & Rate Limiting
  C->>RL: POST /v1/payments
  RL->>R: Check rate limit
  alt Rate limit exceeded
    RL-->>C: 429 Too Many Requests
  else Within limits
    RL->>LB: Forward request
    LB->>GW: Route to gateway
  end

  %% Idempotency Check
  GW->>R: Check idempotency key
  alt Duplicate request
    R-->>GW: Cached response
    GW-->>C: Return cached result
  else New request
    GW->>P: Process payment (JWT validated)
  end

  %% Fraud Detection
  P->>FR: Validate transaction
  FR->>DBR: Read user history
  FR->>R: Check velocity limits
  FR-->>P: Risk score
  alt High risk score
    P-->>GW: Transaction rejected
    GW-->>C: 403 Fraud detected
  else Acceptable risk
    P->>P: Continue processing
  end

  %% Payment Processing
  P->>DBW: Begin transaction
  P->>DBW: Insert payment record
  P->>PSP: Authorize payment
  
  alt PSP Success
    PSP-->>P: Authorization approved
    P->>DBW: Update status = AUTHORIZED
    P->>K: Publish PAYMENT_AUTHORIZED
    
    %% Capture Phase
    P->>PSP: Capture payment
    PSP-->>P: Capture confirmed
    P->>DBW: Update status = CAPTURED
    P->>DBW: Commit transaction
    
    %% Async Processing
    P->>K: Publish PAYMENT_CAPTURED
    K-->>L: Process ledger entry
    L->>DBW: Record double-entry
    
    %% Success Response
    P-->>GW: Payment successful
    GW->>R: Cache response
    GW-->>C: 201 Payment created
    
  else PSP Failure
    PSP-->>P: Authorization failed
    P->>DBW: Rollback transaction
    P->>K: Publish PAYMENT_FAILED
    P-->>GW: Payment failed
    GW-->>C: 402 Payment required
  end

  %% Async Reconciliation
  rect rgb(240,248,255)
    Note over K,L: Async processes continue
    K-->>K: Notification events
    K-->>K: Settlement events
    K-->>K: Reconciliation events
  end