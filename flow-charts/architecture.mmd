%% /architecture.mmd - Updated for MTN Irancell Requirements
graph TB
  U[Mobile/Web/Partner Channels]:::edge

  %% Active Site (Tehran) - Availability Zone 1
  subgraph DC_A["Primary DC — Tehran AZ-1 (Active)"]
    %% Edge Layer
    WAF[WAF + DDoS Protection]:::ctrl
    RL[Rate Limiter\nToken Bucket/Sliding Window\nPer-client limits]:::ctrl
    LB[NGINX Load Balancer\n100K req capacity\nHealth checks, Sticky sessions]:::ctrl
    
    %% API Gateway Cluster
    GW[API Gateway Cluster\nTLS 1.3, mTLS, OAuth2\nIdempotency, PII scrubbing]:::core

    %% Auth & Control
    IDP["Keycloak (OIDC/SAML)\nMFA, RBAC, Service accounts"]:::ctrl
    FLG[Feature Flags/Kill-switches\nAudit trail, A/B testing]:::ctrl

    %% Core Services
    PAY["Payments Service\nOrchestration/Saga Pattern\nValidation, Outbox pattern"]:::core
    WAL[Wallet Service\nBalances, Reservations\nCash-in/out operations]:::core
    
    %% Enhanced Fraud Detection
    FRD[Fraud Detection Service\nML Risk Scoring\nVelocity Checks\nDevice Fingerprinting\nRule Engine Integration]:::edge
    
    %% PSP Adapters
    ADP_A[PSP Adapter A\nTimeout/Retry+Jitter\nCircuit Breaker, Bulkhead]:::core
    ADP_B[PSP Adapter B\nFailover, Health metrics]:::core
    ADP_BANK[Bank Adapter\nDirect APIs, Settlement]:::core

    %% Webhook Processing
    WH[Webhook Ingest\nAllowlist + mTLS/HMAC\nStore-then-ack pattern]:::core

    %% Financial Services
    LED["Ledger Service\nDouble-entry bookkeeping\nAppend-only, Idempotent"]:::state
    RCN[Reconciliation Service\nT+0 stream, T+1 batch\nBreak detection → DLQ]:::state

    %% Message Broker (Enhanced)
    EV[(Kafka Cluster\nEvent streaming\nAsync processing\nDLQ + Replay capability\nPartitioned for scale)]:::data
    
    %% PostgreSQL Master
    DB_MASTER[(PostgreSQL Master\nWrite operations only\nSynchronous replication\nOLTP optimized)]:::data
    
    %% Read Replicas
    DB_READ1[(PostgreSQL Read Replica 1\nRead operations\nAsync replication)]:::data
    
    %% Cache Layer
    RDS[(Redis Cluster\nRate limit counters\nIdempotency keys\nDistributed locks\nSession cache)]:::data
    
    %% Object Storage
    OBJ[(MinIO / S3-compat\nWebhook payloads\nSettlement files\nAudit logs)]:::data

    %% Security
    KMS["Vault (Secrets/KMS)\nRotation policies"]:::ctrl
    HSM["HSM (Tokenization)\nPIN/PAN encryption"]:::ctrl

    %% Observability Stack (No Prometheus)
    OTL[OpenTelemetry Collectors\nMetrics, Traces, Logs]:::obs
    APM[Application Performance Monitor\nError rate tracking\nTransaction metrics\nBusiness KPIs]:::obs
    LOKI[(Loki\nLog Aggregation\nFull-text search)]:::obs
    TEMPO[(Tempo\nDistributed Tracing\nLatency analysis)]:::obs
    AM[Alert Manager\nError rate > 4% alerts\nBusiness alerts]:::obs
    GRAF[Grafana Dashboards\nUnified visualization\nLoki + Tempo + APM]:::obs
  end

  %% Secondary Site - Availability Zone 2
  subgraph DC_B["Secondary DC — Tehran AZ-2 (Active Replica)"]
    LB_B[NGINX Load Balancer\nStandby/Active]:::ctrl
    GW_B["API Gateway (Active)"]:::core
    PAY_B["Payments Service (Active)\nAuto-scaled replicas"]:::core
    
    DB_READ2[(PostgreSQL Read Replica 2\nRead operations\nAsync replication)]:::data
    DB_STANDBY[(PostgreSQL Standby Master\nSynchronous replication\nAutomatic failover ready)]:::data
    
    EV_B[(Kafka Replica\nMirrored topics)]:::data
    RDS_B[(Redis Replica)]:::data
    
    OTL_B[OpenTelemetry Collectors]:::obs
    LOKI_B[(Loki Replica)]:::obs
    TEMPO_B[(Tempo Replica)]:::obs
    GRAF_B[Grafana (Standby)]:::obs
  end

  %% DR Site (Passive) - Different Region
  subgraph DC_DR["DR Site — Different Region (Passive)"]
    DB_DR[(PostgreSQL DR\nAsync replication\nRPO ≤ 5 min)]:::data
    EV_DR[(Kafka DR Mirror)]:::data
    OBJ_DR[(Object Storage Replica)]:::data
    FULL_DR[Complete Service Stack\n(Cold standby)]:::core
  end

  %% External Systems
  PSP1[PSP 1\nPayment Gateway]:::ext
  PSP2[PSP 2\nBackup Gateway]:::ext
  BANK["Bank/Core Banking\nSettlement System"]:::ext
  SFTP["SFTP Server\nSettlement Files"]:::ext

  %% Traffic Flow
  U -->|HTTPS| WAF
  WAF --> RL
  RL -->|Rate limited| LB
  LB -->|Round-robin/Weighted| GW
  LB -.->|Failover| LB_B
  
  %% API Gateway Routes
  GW --> IDP
  GW --> PAY
  GW --> WAL
  GW --> FRD

  %% Payment Processing
  PAY -->|Validate| FRD
  FRD -->|Risk Score| PAY
  PAY -->|Route| ADP_A
  PAY -->|Failover| ADP_B
  PAY -->|Direct debit| ADP_BANK
  
  %% External Integrations
  ADP_A <-->|mTLS+HMAC| PSP1
  ADP_B <-->|mTLS+HMAC| PSP2
  ADP_BANK <-->|Secure API| BANK

  %% Webhook Processing
  PSP1 -->|Webhooks| WH
  PSP2 -->|Webhooks| WH
  WH -->|Publish| EV

  %% Event-Driven Architecture
  PAY -->|Produce events| EV
  EV -->|Consume| LED
  EV -->|Consume| RCN
  EV -->|Consume| WAL
  RCN -->|Store| OBJ
  WH -->|Archive| OBJ
  SFTP <--> OBJ
  RCN --> SFTP

  %% Database Operations
  PAY -->|Write| DB_MASTER
  WAL -->|Write| DB_MASTER
  LED -->|Write| DB_MASTER
  
  PAY -->|Read| DB_READ1
  WAL -->|Read| DB_READ1
  
  %% Database Replication
  DB_MASTER -->|Sync replication| DB_STANDBY
  DB_MASTER -->|Async replication| DB_READ1
  DB_MASTER -->|Async replication| DB_READ2
  DB_MASTER -->|Async replication| DB_DR
  
  %% Cache Operations
  PAY --> RDS
  GW --> RDS
  RL --> RDS
  FRD --> RDS

  %% Security Integration
  PAY --> KMS
  ADP_A --> KMS
  ADP_B --> KMS
  LED --> HSM
  PAY --> FLG
  
  %% Observability (OpenTelemetry + Loki + Tempo + Grafana)
  GW --> OTL
  PAY --> OTL
  WAL --> OTL
  FRD --> OTL
  ADP_A --> OTL
  ADP_B --> OTL
  LED --> OTL
  RCN --> OTL
  WH --> OTL
  
  OTL -->|Metrics| APM
  OTL -->|Logs| LOKI
  OTL -->|Traces| TEMPO
  APM -->|Error rate > 4%| AM
  APM --> GRAF
  LOKI --> GRAF
  TEMPO --> GRAF
  
  %% Cross-AZ Replication
  EV -->|Mirror| EV_B
  RDS -->|Replicate| RDS_B
  OTL --> OTL_B
  LOKI -->|Replicate| LOKI_B
  TEMPO -->|Replicate| TEMPO_B
  APM --> GRAF_B
  
  %% DR Replication
  EV_B -->|Async Mirror| EV_DR
  OBJ -->|Bucket sync| OBJ_DR

  classDef core fill:#e3f2fd,stroke:#1976d2,stroke-width:2px;
  classDef state fill:#e8f5e8,stroke:#388e3c,stroke-width:2px;
  classDef data fill:#fff3e0,stroke:#f57c00,stroke-width:2px;
  classDef obs fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px;
  classDef ctrl fill:#e0f2f1,stroke:#00796b,stroke-width:2px;
  classDef edge fill:#fafafa,stroke:#616161,stroke-width:1px;
  classDef ext fill:#ffebee,stroke:#c62828,stroke-width:2px;